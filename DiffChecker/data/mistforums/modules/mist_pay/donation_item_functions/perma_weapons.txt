local PMeta = FindMetaTable("Player")

file.CreateDir("mistforums_perma_weapons")

local permaWeaponFilePath = "mistforums_perma_weapons/%s.txt"

function PMeta:getPermaWeaponFilePath()
	return string.format(permaWeaponFilePath, string.gsub(self:SteamID(), ":", "_"));
end

function PMeta:loadPermaWeaponsFromFile()
	return self:getPermaWeapons(true)
end

function PMeta:getPermaWeapons(forceRead)
	forceRead = forceRead or false
	
	if ( self._getPermaWeapons && !forceRead ) then
		return self._getPermaWeapons;
	end
	
	local filePath = self:getPermaWeaponFilePath()
	
	self._getPermaWeapons = util.JSONToTable( file.Exists( filePath, "DATA" ) and file.Read(filePath, "DATA") or "[]" )
	
	return self._getPermaWeapons;
end

function PMeta:givePermaWeapon( name )
	local permaWeapons = self:getPermaWeapons()
	
	table.insert( permaWeapons, name )
	
	file.Write( self:getPermaWeaponFilePath(), util.TableToJSON( permaWeapons ) )
	
	self:Give( name )
	
	self:loadPermaWeaponsFromFile()
end

hook.Add("PlayerSpawn", "mistForum.givePermaWeapon", function( ply )
	timer.Simple(5, function()
		if ( IsValid( ply ) ) then
			for k, v in pairs( ply:getPermaWeapons() ) do
				ply:Give( v )
			end
		end
	end)
end )
